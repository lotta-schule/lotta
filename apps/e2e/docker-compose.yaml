include:
  - path: ../core-api/docker-compose.services.base.yaml

services:
  web:
    image: ${LOTTA_WEB_IMAGE:-ghcr.io/lotta-schule/web:${LOTTA_WEB_VERSION:-${IMAGE_TAG:-latest}}}
    ports:
      - '3000:3000'
    depends_on:
      core:
        condition: service_healthy
    env_file: env-file
    healthcheck:
      test:
        [
          'CMD',
          'node',
          '-e',
          'require("http").get("http://localhost:3000/dbg/health", { timeout: 5000 }, res => process.exit(res.statusCode === 200 ? 0 : 1)).on("error", () => process.exit(1))',
        ]
      interval: 30s
      timeout: 10s
      retries: 5

  core:
    image: ${LOTTA_CORE_IMAGE:-ghcr.io/lotta-schule/core:${LOTTA_CORE_VERSION:-${IMAGE_TAG:-latest}}}
    ports:
      - 4000:4000
    depends_on:
      postgres:
        condition: service_healthy
      redis:
        condition: service_healthy
      minio:
        condition: service_healthy
    healthcheck:
      test:
        [
          'CMD',
          'wget',
          '--no-verbose',
          '--tries=1',
          '--spider',
          'http://localhost:4000/_debug/health',
        ]
      interval: 30s
      timeout: 10s
      retries: 5
    env_file: env-file
