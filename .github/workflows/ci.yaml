# yaml-language-server: $schema=https://www.schemastore.org/github-workflow.json
---
name: 'CI'
on:
  push:
    branches:
      - '*'
      - '*/*'
      - '**'
    tags-ignore:
      - 'v*'

env:
  NX_CLOUD_ACCESS_TOKEN: ${{ secrets.NX_CLOUD_ACCESS_TOKEN }}
  NX_NO_CLOUD: ${{ vars.NX_NO_CLOUD }}
  GITHUB_ACTIONS: true

jobs:
  pnpm-install:
    name: Install (and cache) dependencies
    runs-on: ubuntu-24.04
    steps:
      - name: Checkout Repo
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup PNPM package manager
        uses: pnpm/action-setup@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 24.5
          cache: 'pnpm'

      - name: Install npm dependencies
        run: pnpm install

  lint:
    name: Lint Code
    runs-on: ubuntu-24.04
    needs: pnpm-install
    steps:
      - name: Checkout Repo
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup main branch for reference
        if: ${{ github.ref_name != 'main' }}
        run: git branch --track main origin/main

      - name: Setup NX
        uses: nrwl/nx-set-shas@v3

      - name: Setup PNPM package manager
        uses: pnpm/action-setup@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 24.5
          cache: 'pnpm'

      - name: Setup the BEAM and Elixir
        uses: erlef/setup-beam@v1
        with:
          otp-version: '28.0.2'
          elixir-version: '1.18.4'

      - name: Install node dependencies
        run: pnpm install

      - name: Lint
        run: pnpm nx affected -t lint

      - name: Typecheck
        run: pnpm nx affected -t typecheck

  tests:
    name: Run tests
    runs-on: ubuntu-24.04
    needs: pnpm-install
    env:
      TZ: Europe/Berlin
      LOCALE: de_DE.UTF-8
    services:
      postgres:
        image: postgres:latest
        ports:
          - 5432:5432
        options: >-
          -e POSTGRES_USER=lotta
          -e POSTGRES_PASSWORD=lotta
      redis:
        image: bitnamilegacy/redis:latest
        ports:
          - 6379:6379
        options: >-
          -e REDIS_PASSWORD=lotta
      minio:
        image: lazybit/minio
        ports:
          - 9000:9000
        env:
          MINIO_ACCESS_KEY: AKIAIOSFODNN7EXAMPLE
          MINIO_SECRET_KEY: wJalrXUtnFEMI/K7MDENG/bPxRfiCYEXAMPLEKEY
        options: >-
          --name minio
          --health-cmd "curl http://localhost:9000/minio/health/live"
    steps:
      - name: Checkout Repo
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup main branch for reference
        if: ${{ github.ref_name != 'main' }}
        run: git branch --track main origin/main

      - name: Setup NX
        uses: nrwl/nx-set-shas@v3

      - name: Setup PNPM package manager
        uses: pnpm/action-setup@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 24.5
          cache: 'pnpm'

      - uses: actions/cache@v4
        with:
          path: |
            deps
            _build
          key: ${{ runner.os }}-elixir-mix-${{ hashFiles('**/mix.lock') }}

      - name: Setup the BEAM and Elixir
        uses: erlef/setup-beam@v1
        with:
          otp-version: '28.0.2'
          elixir-version: '1.18.4'

      - uses: hostwithquantum/setup-mc@main
        with:
          alias-name: minio
          alias-url: http://localhost:9000
          alias-access-key: AKIAIOSFODNN7EXAMPLE
          alias-secret-key: wJalrXUtnFEMI/K7MDENG/bPxRfiCYEXAMPLEKEY

      - run: |
          mc mb minio/lotta-dev-ugc
          mc anonymous set download minio/lotta-dev-ugc

      - name: Install npm dependencies
        run: pnpm install

      - name: Install playwright browsers
        run: |
          pnpm exec playwright install --with-deps chromium

      - name: Run Unit / Component tests
        run: pnpm nx run-many -t test --configuration=coverage
        env:
          NODE_ENV: test
          MIX_ENV: test

      - name: Upload Test Traces for the webapp
        uses: actions/upload-artifact@v4
        if: ${{ !cancelled() }}
        with:
          name: web-vitest-traces
          path: apps/webapp/.test-reports/traces
          retention-days: 7

      - name: Upload Test Screenshots for the webapp
        uses: actions/upload-artifact@v4
        if: ${{ !cancelled() }}
        with:
          name: web-vitest-screenshots
          path: apps/webapp/.test-reports/screenshots
          retention-days: 7

      - name: Upload Test Traces for the hubert
        uses: actions/upload-artifact@v4
        if: ${{ !cancelled() }}
        with:
          name: hubert-vitest-traces
          path: libs/hubert/.test-reports/traces
          retention-days: 7

      - name: Upload Test Screenshots for the hubert
        uses: actions/upload-artifact@v4
        if: ${{ !cancelled() }}
        with:
          name: hubert-vitest-screenshots
          path: libs/hubert/.test-reports/screenshots
          retention-days: 7

      - name: Upload Tests for storybook-addon-theme
        uses: codecov/codecov-action@v5
        if: ${{ !cancelled() }}
        with:
          directory: libs/storybook-addon-theme/coverage/
          flags: storybook-addon-theme
          token: ${{ secrets.CODECOV_TOKEN }}
          verbose: true

      - name: Upload Tests for hubert
        uses: codecov/codecov-action@v5
        if: ${{ !cancelled() }}
        with:
          directory: libs/hubert/coverage/
          flags: hubert
          token: ${{ secrets.CODECOV_TOKEN }}
          verbose: true

      - name: Upload Tests for Webapp
        uses: codecov/codecov-action@v5
        if: ${{ !cancelled() }}
        with:
          directory: apps/webapp/coverage/
          flags: webapp
          token: ${{ secrets.CODECOV_TOKEN }}
          verbose: true

      - name: Upload Tests for CoreApi
        uses: codecov/codecov-action@v5
        if: ${{ !cancelled() }}
        with:
          directory: apps/core-api/cover/
          flags: core-api
          token: ${{ secrets.CODECOV_TOKEN }}
          verbose: true

  upload-report:
    runs-on: ubuntu-24.04
    if: ${{ always() }}
    continue-on-error: true

    permissions:
      contents: write
      pull-requests: write

    needs:
      - tests

    strategy:
      matrix:
        project:
          - app: apps/webapp
            traces-artifact: web-vitest-traces
            screenshot-artifact: web-vitest-screenshots
          - app: libs/hubert
            traces-artifact: hubert-vitest-traces
            screenshot-artifact: hubert-vitest-screenshots
    steps:
      - name: Set up S3cmd cli tool
        uses: s3-actions/s3cmd@v1.9.0
        with:
          provider: scaleway
          region: 'nl-ams'
          access_key: ${{ secrets.PUBLIC_BUCKET_AWS_ACCESS_KEY_ID }}
          secret_key: ${{ secrets.PUBLIC_BUCKET_AWS_SECRET_ACCESS_KEY }}

      - name: Download traces reports from GitHub Actions Artifacts
        uses: actions/download-artifact@v4
        with:
          name: ${{ matrix.project.traces-artifact }}
          path: /tmp/${{matrix.project.traces-artifact}}/traces

      - name: Upload HTML report to S3
        id: upload-traces
        run: |
          export REPORT_PATH="/test/${{ github.base_ref || github.ref_name }}/${{ matrix.project.traces-artifact }}"
          s3cmd sync --acl-public --recursive --no-mime-magic --guess-mime-type  \
            /tmp/${{matrix.project.traces-artifact}}/ \
            s3://public-lotta-assets$REPORT_PATH/

          echo "report_url=https://public-lotta-assets.s3-website.nl-ams.scw.cloud$REPORT_PATH/index.html" >> $GITHUB_OUTPUT

      - name: Download screenshot reports from GitHub Actions Artifacts
        uses: actions/download-artifact@v4
        with:
          path: /tmp/${{matrix.project.traces-artifact}}/screenshots
          pattern: ${{ matrix.project.screenshot-artifact }}
          merge-multiple: true

      - name: Upload Screenshots to S3
        id: upload-screenshots
        if: ${{ hashFiles('/tmp/' + matrix.project.traces-artifact + '/screenshots/**') != '' }}
        run: |
          export REPORT_PATH="/test/${{ github.base_ref || github.ref_name }}/${{ matrix.project.screenshot-artifact }}"
          s3cmd sync --acl-public --recursive --no-mime-magic --guess-mime-type  \
            /tmp/${{matrix.project.screenshot-artifact}}/ \
            s3://public-lotta-assets$REPORT_PATH/

          echo "report_url=https://public-lotta-assets.s3-website.nl-ams.scw.cloud$REPORT_PATH/index.html" >> $GITHUB_OUTPUT

      - name: Comment PR with execution number
        uses: thollander/actions-comment-pull-request@v3
        if: ${{ github.event_name == 'pull_request' }}
        with:
          message: |
            ## Component Test Report ${{ matrix.project.app }}

            ### Traces
            See [Playwright traces](${{ steps.upload-traces.outputs.report_url }})

            ### Screenshots
            See [Screenshots](${{ steps.upload-screenshots.outputs.report_url }})
          comment-tag: playwright-report

      - name: Create commit comment
        uses: peter-evans/commit-comment@v3
        if: ${{ github.event_name == 'push' }}
        with:
          body: |
            ## Component Test Report ${{ matrix.project.app }}

            ### Traces
            See [Playwright traces](${{ steps.upload-traces.outputs.report_url }})

            ### Screenshots
            See [Screenshots](${{ steps.upload-screenshots.outputs.report_url }})

  check-build:
    # We do not need to check the build for environments that are
    # to be deployed to a preview (or staging) environment shortly
    # TODO: The pull request check is now Quark, as it is not pupulated
    # with the labels. Maybe github-api can be used to get the labels?
    name: Check the projects build
    runs-on: ubuntu-24.04
    needs: pnpm-install
    steps:
      - name: Checkout Repo
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
        if: ${{ github.ref_name != 'main' && !contains(github.event.pull_request.labels.*.name, 'preview') }}

      - name: Setup main branch for reference
        if: ${{ github.ref_name != 'main' && !contains(github.event.pull_request.labels.*.name, 'preview') }}
        run: git branch --track main origin/main

      - name: Setup NX
        uses: nrwl/nx-set-shas@v3
        if: ${{ github.ref_name != 'main' && !contains(github.event.pull_request.labels.*.name, 'preview') }}

      - name: Setup PNPM package manager
        uses: pnpm/action-setup@v3
        if: ${{ github.ref_name != 'main' && !contains(github.event.pull_request.labels.*.name, 'preview') }}
        with:
          version: 10

      - name: Setup Node.js
        uses: actions/setup-node@v4
        if: ${{ github.ref_name != 'main' && !contains(github.event.pull_request.labels.*.name, 'preview') }}
        with:
          node-version: 24.5
          cache: 'pnpm'

      - name: Setup the BEAM and Elixir
        if: ${{ github.ref_name != 'main' && !contains(github.event.pull_request.labels.*.name, 'preview') }}
        uses: erlef/setup-beam@v1
        with:
          otp-version: '28.0.2'
          elixir-version: '1.18.4'

      - name: Install npm dependencies
        if: ${{ github.ref_name != 'main' && !contains(github.event.pull_request.labels.*.name, 'preview') }}
        run: pnpm install

      - name: Run build task
        if: ${{ github.ref_name != 'main' && !contains(github.event.pull_request.labels.*.name, 'preview') }}
        run: pnpm nx affected -t build
