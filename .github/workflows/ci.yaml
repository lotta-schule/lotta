---
name: 'CI'
on:
  push: {}
  pull_request:
    types: [opened, synchronize, labeled]

env:
  NX_CLOUD_ACCESS_TOKEN: ${{ secrets.NX_CLOUD_ACCESS_TOKEN }}
  NX_NO_CLOUD: ${{ vars.NX_NO_CLOUD }}
  GITHUB_ACTIONS: true

concurrency:
  group: ${{ github.event.pull_request.head.sha || github.sha }}
  cancel-in-progress: ${{ github.event_name == 'push' }}

jobs:
  run_checks:
    name: Run code checks
    uses: ./.github/workflows/__run_checks.yaml
    with:
      skip_build: ${{ github.ref_name != 'main' && !contains(github.event.pull_request.labels.*.name, 'preview') }}
    secrets: inherit

  cd:
    name: Build & Deploy Docker images
    needs:
      - run_checks
    uses: ./.github/workflows/cd.yaml
    if: github.ref_name == 'main' || startsWith(github.ref_name, 'release/') || contains(github.event.pull_request.labels.*.name, 'preview')
    with:
      image_tag: ${{ github.event.pull_request.head.sha || github.sha }}
    secrets: inherit
